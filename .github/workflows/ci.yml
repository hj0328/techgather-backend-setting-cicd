name: CI

on:
  push:
    branches:
      - "feature/*"
      - "development"
      - "master"

  workflow_dispatch:
    inputs:
      target_service:
        type: choice
        description: "배포할 서비스 선택"
        options:
          - all
          - authentication
          - api
          - batch
          - collector

jobs:
  detect_changes:
    runs-on: ubuntu-latest
    outputs:
      auth_changed: ${{ steps.filter.outputs.auth }}
      api_changed: ${{ steps.filter.outputs.api }}
      batch_changed: ${{ steps.filter.outputs.batch }}
      collector_changed: ${{ steps.filter.outputs.collector }}
      common_changed: ${{ steps.filter.outputs.common }}
    steps:
      - uses: actions/checkout@v4

      # 변경 파일 감지(paths-filter)
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:
              - 'authentication/**'
            api:
              - 'api/**'
            batch:
              - 'batch/**'
            collector:
              - 'collector/**'
            common:
              - 'application/**'
              - 'domain/**'

  # authentication / api / batch / collector 각각 별도 Job
  build_authentication:
    needs: detect_changes
    runs-on: ubuntu-latest
    if: needs.detect_changes.outputs.auth_changed == 'true' || needs.detect_changes.outputs.common_changed == 'true'

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build authentication
        run: ./gradlew :authentication:clean :authentication:build

      # development, master 브랜치 → docker build
      - name: Docker Build (auth)
        if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/master'
        run: |
          docker build -t ${{ secrets.DOCKER_REPO }}:authentication-latest authentication/

      - name: DockerHub Login
        if: github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # master → docker push
      - name: Docker Push (auth)
        if: github.ref == 'refs/heads/master'
        run: docker push ${{ secrets.DOCKER_REPO }}:authentication-latest

  build_api:
    needs: detect_changes
    runs-on: ubuntu-latest
    if: needs.detect_changes.outputs.api_changed == 'true' || needs.detect_changes.outputs.common_changed == 'true'

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build api
        run: ./gradlew :api:clean :api:build

      - name: Docker Build (api)
        if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/master'
        run: docker build -t ${{ secrets.DOCKER_REPO }}:api-latest api/

      - name: DockerHub Login
        if: github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Push (api)
        if: github.ref == 'refs/heads/master'
        run: docker push ${{ secrets.DOCKER_REPO }}:api-latest

  build_batch:
    needs: detect_changes
    runs-on: ubuntu-latest
    if: needs.detect_changes.outputs.batch_changed == 'true' || needs.detect_changes.outputs.common_changed == 'true'

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build batch
        run: ./gradlew :batch:clean :batch:build

      - name: Docker Build (batch)
        if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/master'
        run: docker build -t ${{ secrets.DOCKER_REPO }}:batch-latest batch/

      - name: DockerHub Login
        if: github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Push (batch)
        if: github.ref == 'refs/heads/master'
        run: docker push ${{ secrets.DOCKER_REPO }}:batch-latest

  build_collector:
    needs: detect_changes
    runs-on: ubuntu-latest
    if: needs.detect_changes.outputs.collector_changed == 'true' || needs.detect_changes.outputs.common_changed == 'true'

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build collector
        run: ./gradlew :collector:bootJar --no-daemon

      - name: Docker Build (collector)
        if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/master'
        run: |
          docker build -f collector/Dockerfile -t ${{ secrets.DOCKER_REPO }}:collector-latest .

      - name: DockerHub Login
        if: github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Push (collector)
        if: github.ref == 'refs/heads/master'
        run: docker push ${{ secrets.DOCKER_REPO }}:collector-latest

  # DEPLOY JOB (workflow_dispatch)
  deploy:
    needs: [build_authentication, build_api, build_batch, build_collector]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_KEY }} ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
          
            if [[ "${{ github.event.inputs.target_service }}" == "all" || "${{ github.event.inputs.target_service }}" == "authentication" ]]; then
              docker pull ${{ secrets.DOCKER_REPO }}:authentication-latest
            fi

            if [[ "${{ github.event.inputs.target_service }}" == "all" || "${{ github.event.inputs.target_service }}" == "api" ]]; then
              docker pull ${{ secrets.DOCKER_REPO }}:api-latest
            fi

            if [[ "${{ github.event.inputs.target_service }}" == "all" || "${{ github.event.inputs.target_service }}" == "batch" ]]; then
              docker pull ${{ secrets.DOCKER_REPO }}:batch-latest
            fi

            if [[ "${{ github.event.inputs.target_service }}" == "all" || "${{ github.event.inputs.target_service }}" == "collector" ]]; then
              docker pull ${{ secrets.DOCKER_REPO }}:collector-latest
            fi

            cd /home/ec2-user/tech-gather
            docker compose down
            docker compose up -d --remove-orphans

          EOF
