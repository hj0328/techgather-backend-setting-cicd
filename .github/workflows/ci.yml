name: CI/CD Pipeline

env:
  DOCKER_REPO: ${{ secrets.DOCKER_REPO }}
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

on:
  push:
    branches:
      - "feature/*"
      - "development"
      - "master"

  workflow_dispatch:
    inputs:
      target_service:
        type: choice
        description: "배포할 서비스 선택"
        options:
          - authentication
          - api

jobs:
  detect_changes:
    runs-on: ubuntu-latest
    outputs:
      auth_changed: ${{ steps.filter.outputs.auth }}
      api_changed: ${{ steps.filter.outputs.api }}
      batch_changed: ${{ steps.filter.outputs.batch }}
      collector_changed: ${{ steps.filter.outputs.collector }}
      common_changed: ${{ steps.filter.outputs.common }}

    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:
              - 'authentication/**'
            api:
              - 'api/**'
            batch:
              - 'batch/**'
            collector:
              - 'collector/**'
            common:
              - 'application/**'
              - 'domain/**'

  authentication:
    needs: detect_changes
    if: github.event_name == 'push' && (
      needs.detect_changes.outputs.auth_changed == 'true' || 
      needs.detect_changes.outputs.common_changed == 'true'
      )
    uses: ./.github/workflows/common-build.yml
    with:
      module: "authentication"
      gradle_task: "build"
      docker_context: "authentication"
      dockerfile: "authentication/Dockerfile"
      image_name: "authentication"

  api:
    needs: detect_changes
    if: github.event_name == 'push' &&  (
      needs.detect_changes.outputs.api_changed == 'true' || 
      needs.detect_changes.outputs.common_changed == 'true'
      )
    uses: ./.github/workflows/common-build.yml
    with:
      module: "api"
      gradle_task: "build"
      docker_context: "api"
      dockerfile: "api/Dockerfile"
      image_name: "api"

  batch:
    needs: detect_changes
    if: github.event_name == 'push' && (
      needs.detect_changes.outputs.batch_changed == 'true' || 
      needs.detect_changes.outputs.common_changed == 'true'
      )
    uses: ./.github/workflows/common-build.yml
    with:
      module: "batch"
      gradle_task: "build"
      docker_context: "batch"
      dockerfile: "batch/Dockerfile"
      image_name: "batch"

  collector:
    needs: detect_changes
    if: github.event_name == 'push' && (
      needs.detect_changes.outputs.collector_changed == 'true' ||
      needs.detect_changes.outputs.common_changed == 'true'
      )
    uses: ./.github/workflows/common-build.yml
    with:
      module: "collector"
      gradle_task: "bootJar"
      docker_context: "."
      dockerfile: "collector/Dockerfile"
      image_name: "collector"

  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: Load module config
        id: config
        run: |
          CONFIG=$(base64 -w 0 deploy/modules.json)
          echo "CONFIG=$CONFIG" >> "$GITHUB_OUTPUT"

      - name: Create SSH key file
        run: |
          echo "${{ secrets.EC2_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem

      - name: Deploy to EC2
        run: |
          TARGET="${{ github.event.inputs.target_service }}"
          CONFIG_JSON=$(echo "${{ steps.config.outputs.CONFIG }}" | base64 --decode)

          ssh -o StrictHostKeyChecking=no -i ec2_key.pem ec2-user@${{ secrets.EC2_HOST }} << EOF

          if ! command -v jq &> /dev/null; then
            sudo yum install -y jq
          fi

          docker login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}"

          CONFIG='$CONFIG_JSON'

          deploy_service() {
            local NAME=\$1

            local PORT=\$(echo "\$CONFIG" | jq -r ".\"$TARGET\".port")
            local IMAGE=\$(echo "\$CONFIG" | jq -r ".\"$TARGET\".image")
            local HEALTH=\$(echo "\$CONFIG" | jq -r ".\"$TARGET\".health")

            echo "Deploying \$NAME (port \$PORT, image \$IMAGE)"

            docker rename \$NAME \${NAME}_backup 2>/dev/null || true
            docker pull ${{ secrets.DOCKER_REPO }}:\$IMAGE

            docker stop \$NAME || true
            docker rm \$NAME || true

            docker run -d \
              --name \$NAME \
              -p \$PORT:\$PORT \
              -e SPRING_PROFILES_ACTIVE=prod \
              --restart always \
              ${{ secrets.DOCKER_REPO }}:\$IMAGE

            echo "Waiting for health check: \$HEALTH"
            for i in {1..20}; do
              STATUS=\$(curl -s -o /dev/null -w "%{http_code}" "\$HEALTH" || true)

              if [[ "\$STATUS" == "200" ]]; then
                echo "\$NAME health check successful!"
                docker rm -f \${NAME}_backup 2>/dev/null || true
                return 0
              fi

              echo "Health check failed (\$STATUS). Retry \$i/20..."
              sleep 3
            done

            echo "Health check failed. Rolling back..."

            docker stop \$NAME
            docker rm \$NAME

            docker rename \${NAME}_backup \$NAME
            docker start \$NAME

            echo "Rollback completed for \$NAME"
            exit 1
          }

          deploy_service "$TARGET"

          EOF
