name: CI/CD Pipeline

on:
  push:
    branches:
      - "feature/*"
      - "development"
      - "master"

  workflow_dispatch:
    inputs:
      target_service:
        type: choice
        description: "배포할 서비스 선택"
        options:
          - authentication
          - api

jobs:
  detect_changes:
    runs-on: ubuntu-latest
    outputs:
      auth_changed: ${{ steps.filter.outputs.auth }}
      api_changed: ${{ steps.filter.outputs.api }}
      batch_changed: ${{ steps.filter.outputs.batch }}
      collector_changed: ${{ steps.filter.outputs.collector }}
      common_changed: ${{ steps.filter.outputs.common }}

    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:
              - 'authentication/**'
            api:
              - 'api/**'
            batch:
              - 'batch/**'
            collector:
              - 'collector/**'
            common:
              - 'application/**'
              - 'domain/**'

  build_authentication:
    needs: detect_changes
    runs-on: ubuntu-latest
    if: needs.detect_changes.outputs.auth_changed == 'true' ||
      needs.detect_changes.outputs.common_changed == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build authentication
        run: ./gradlew :authentication:clean :authentication:build --no-daemon

      - name: Docker Build (authentication)
        if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/master'
        run: |
          docker build \
            -t ${{ secrets.DOCKER_REPO }}:authentication-latest \
            -t ${{ secrets.DOCKER_REPO }}:authentication-${{ github.sha }} \
            authentication/

      - name: DockerHub Login
        if: github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Push (authentication)
        if: github.ref == 'refs/heads/master'
        run: |
          docker push ${{ secrets.DOCKER_REPO }}:authentication-latest
          docker push ${{ secrets.DOCKER_REPO }}:authentication-${{ github.sha }}

  build_api:
    needs: detect_changes
    runs-on: ubuntu-latest
    if: needs.detect_changes.outputs.api_changed == 'true' ||
      needs.detect_changes.outputs.common_changed == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build api
        run: ./gradlew :api:clean :api:build --no-daemon

      - name: Docker Build (api)
        if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/master'
        run: |
          docker build \
            -t ${{ secrets.DOCKER_REPO }}:api-latest \
            -t ${{ secrets.DOCKER_REPO }}:api-${{ github.sha }} \
            api/

      - name: DockerHub Login
        if: github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Push (api)
        if: github.ref == 'refs/heads/master'
        run: |
          docker push ${{ secrets.DOCKER_REPO }}:api-latest
          docker push ${{ secrets.DOCKER_REPO }}:api-${{ github.sha }}

  build_batch:
    needs: detect_changes
    runs-on: ubuntu-latest
    if: needs.detect_changes.outputs.batch_changed == 'true' ||
      needs.detect_changes.outputs.common_changed == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build batch
        run: ./gradlew :batch:clean :batch:build --no-daemon

      - name: Docker Build (batch)
        if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/master'
        run: |
          docker build \
            -t ${{ secrets.DOCKER_REPO }}:batch-latest \
            -t ${{ secrets.DOCKER_REPO }}:batch-${{ github.sha }} \
            batch/

      - name: DockerHub Login
        if: github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Push (batch)
        if: github.ref == 'refs/heads/master'
        run: |
          docker push ${{ secrets.DOCKER_REPO }}:batch-latest
          docker push ${{ secrets.DOCKER_REPO }}:batch-${{ github.sha }}

  build_collector:
    needs: detect_changes
    runs-on: ubuntu-latest
    if: needs.detect_changes.outputs.collector_changed == 'true' ||
      needs.detect_changes.outputs.common_changed == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build collector
        run: ./gradlew :collector:bootJar --no-daemon

      - name: Docker Build (collector)
        if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/master'
        run: |
          docker build -f collector/Dockerfile \
            -t ${{ secrets.DOCKER_REPO }}:collector-latest \
            -t ${{ secrets.DOCKER_REPO }}:collector-${{ github.sha }} \
            .

      - name: DockerHub Login
        if: github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Push (collector)
        if: github.ref == 'refs/heads/master'
        run: |
          docker push ${{ secrets.DOCKER_REPO }}:collector-latest
          docker push ${{ secrets.DOCKER_REPO }}:collector-${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: Load module config
        id: config
        run: |
          echo "CONFIG=$(cat deploy/modules.json | base64)" >> $GITHUB_OUTPUT

      - name: Create SSH key file
        run: |
          echo "${{ secrets.EC2_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem

      - name: Deploy to EC2
        run: |
          TARGET="${{ github.event.inputs.target_service }}"
          CONFIG_JSON=$(echo "${{ steps.config.outputs.CONFIG }}" | base64 --decode)

          ssh -o StrictHostKeyChecking=no -i ec2_key.pem ec2-user@${{ secrets.EC2_HOST }} << EOF

          if ! command -v jq &> /dev/null; then
            sudo yum install -y jq
          fi

          docker login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_PASSWORD }}"

          CONFIG='$CONFIG_JSON'

          deploy_service() {
            local NAME=\$1

            local PORT=\$(echo "\$CONFIG" | jq -r ".\"$TARGET\".port")
            local IMAGE=\$(echo "\$CONFIG" | jq -r ".\"$TARGET\".image")
            local HEALTH=\$(echo "\$CONFIG" | jq -r ".\"$TARGET\".health")

            echo "Deploying \$NAME (port \$PORT, image \$IMAGE)"

            docker rename \$NAME \${NAME}_backup 2>/dev/null || true
            docker pull ${{ secrets.DOCKER_REPO }}:\$IMAGE

            docker stop \$NAME || true
            docker rm \$NAME || true

            docker run -d \
              --name \$NAME \
              -p \$PORT:\$PORT \
              -e SPRING_PROFILES_ACTIVE=prod \
              --restart always \
              ${{ secrets.DOCKER_REPO }}:\$IMAGE

            echo "Waiting for health check: \$HEALTH"
            for i in {1..20}; do
              STATUS=\$(curl -s -o /dev/null -w "%{http_code}" "\$HEALTH" || true)

              if [[ "\$STATUS" == "200" ]]; then
                echo "\$NAME health check successful!"
                docker rm -f \${NAME}_backup 2>/dev/null || true
                return 0
              fi

              echo "Health check failed (\$STATUS). Retry \$i/20..."
              sleep 3
            done

            echo "Health check failed. Rolling back..."

            docker stop \$NAME
            docker rm \$NAME

            docker rename \${NAME}_backup \$NAME
            docker start \$NAME

            echo "Rollback completed for \$NAME"
            exit 1
          }

          deploy_service "$TARGET"

          EOF
