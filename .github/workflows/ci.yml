name: CICD

on:
  push:
    branches:
      - "feature/*"
      - "development"
      - "master"

  workflow_dispatch:
    inputs:
      target_service:
        type: choice
        description: "배포할 서비스 선택"
        options:
          - all
          - authentication
          - api
#          - batch
#          - collector

jobs:
  detect_changes:
    runs-on: ubuntu-latest
    outputs:
      auth_changed: ${{ steps.filter.outputs.auth }}
      api_changed: ${{ steps.filter.outputs.api }}
      batch_changed: ${{ steps.filter.outputs.batch }}
      collector_changed: ${{ steps.filter.outputs.collector }}
      common_changed: ${{ steps.filter.outputs.common }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:
              - 'authentication/**'
            api:
              - 'api/**'
            batch:
              - 'batch/**'
            collector:
              - 'collector/**'
            common:
              - 'application/**'
              - 'domain/**'

  build_authentication:
    needs: detect_changes
    runs-on: ubuntu-latest
    if: needs.detect_changes.outputs.auth_changed == 'true' ||
      needs.detect_changes.outputs.common_changed == 'true'

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build authentication
        run: ./gradlew :authentication:clean :authentication:build --no-daemon

      - name: Docker Build (authentication)
        if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/master'
        run: |
          docker build \
            -t ${{ secrets.DOCKER_REPO }}:authentication-latest \
            -t ${{ secrets.DOCKER_REPO }}:authentication-${{ github.sha }} \
            authentication/

      - name: DockerHub Login
        if: github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Docker Push (authentication)
        if: github.ref == 'refs/heads/master'
        run: |
          docker push ${{ secrets.DOCKER_REPO }}:authentication-latest
          docker push ${{ secrets.DOCKER_REPO }}:authentication-${{ github.sha }}

  build_api:
    needs: detect_changes
    runs-on: ubuntu-latest
    if: needs.detect_changes.outputs.api_changed == 'true' ||
      needs.detect_changes.outputs.common_changed == 'true'

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build api
        run: ./gradlew :api:clean :api:build --no-daemon

      - name: Docker Build (api)
        if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/master'
        run: |
          docker build \
            -t ${{ secrets.DOCKER_REPO }}:api-latest \
            -t ${{ secrets.DOCKER_REPO }}:api-${{ github.sha }} \
            api/

      - name: DockerHub Login
        if: github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Docker Push (api)
        if: github.ref == 'refs/heads/master'
        run: |
          docker push ${{ secrets.DOCKER_REPO }}:api-latest
          docker push ${{ secrets.DOCKER_REPO }}:api-${{ github.sha }}

  build_batch:
    needs: detect_changes
    runs-on: ubuntu-latest
    if: needs.detect_changes.outputs.batch_changed == 'true' ||
      needs.detect_changes.outputs.common_changed == 'true'

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build batch
        run: ./gradlew :batch:clean :batch:build --no-daemon

      - name: Docker Build (batch)
        if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/master'
        run: |
          docker build \
            -t ${{ secrets.DOCKER_REPO }}:batch-latest \
            -t ${{ secrets.DOCKER_REPO }}:batch-${{ github.sha }} \
            batch/

      - name: DockerHub Login
        if: github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Docker Push (batch)
        if: github.ref == 'refs/heads/master'
        run: |
          docker push ${{ secrets.DOCKER_REPO }}:batch-latest
          docker push ${{ secrets.DOCKER_REPO }}:batch-${{ github.sha }}

  build_collector:
    needs: detect_changes
    runs-on: ubuntu-latest
    if: needs.detect_changes.outputs.collector_changed == 'true' ||
      needs.detect_changes.outputs.common_changed == 'true'

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build collector
        run: ./gradlew :collector:bootJar --no-daemon

      - name: Docker Build (collector)
        if: github.ref == 'refs/heads/development' || github.ref == 'refs/heads/master'
        run: |
          docker build -f collector/Dockerfile \
            -t ${{ secrets.DOCKER_REPO }}:collector-latest \
            -t ${{ secrets.DOCKER_REPO }}:collector-${{ github.sha }} \
            .

      - name: DockerHub Login
        if: github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Docker Push (collector)
        if: github.ref == 'refs/heads/master'
        run: |
          docker push ${{ secrets.DOCKER_REPO }}:collector-latest
          docker push ${{ secrets.DOCKER_REPO }}:collector-${{ github.sha }}

  # DEPLOY (workflow_dispatch 전용)
  deploy:
    # needs: [build_authentication, build_api, build_batch, build_collector]
    needs: [ build_authentication, build_api ]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Create SSH key file
        run: |
          echo "${{ secrets.EC2_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem
          
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ${{ secrets.EC2_KEY }} ec2-user@${{ secrets.EC2_HOST }} << 'EOF'

          if [[ "${{ github.event.inputs.target_service }}" == "all" || "${{ github.event.inputs.target_service }}" == "authentication" ]]; then
            docker pull ${{ secrets.DOCKER_REPO }}:authentication-latest
          fi

          if [[ "${{ github.event.inputs.target_service }}" == "all" || "${{ github.event.inputs.target_service }}" == "api" ]]; then
            docker pull ${{ secrets.DOCKER_REPO }}:api-latest
          fi

          # if [[ "${{ github.event.inputs.target_service }}" == "all" || "${{ github.event.inputs.target_service }}" == "batch" ]]; then
          #   docker pull ${{ secrets.DOCKER_REPO }}:batch-latest
          # fi

          # if [[ "${{ github.event.inputs.target_service }}" == "all" || "${{ github.event.inputs.target_service }}" == "collector" ]]; then
          #   docker pull ${{ secrets.DOCKER_REPO }}:collector-latest
          # fi

          cd /home/ec2-user/tech-gather
          docker compose down
          docker compose up -d --remove-orphans

          EOF
